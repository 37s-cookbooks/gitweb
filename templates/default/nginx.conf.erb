upstream gitweb_server {
    server 127.0.0.1:<%= @gitweb[:server_port] %> fail_timeout=0;
}

server {
    charset utf8;
    server_tokens off;

    listen <% if @server_host %><%= @server_host %>:<% end %><%= @server_port %>;
    server_name <%= @server_name %>;
    access_log <%= @node[:nginx][:log_dir] %>/<%= @server_name.downcase %>.access.log;

    root <%= @root %>;
    <% if @ssl_certificate %>
    # SSL
    ssl on;
    ssl_certificate <%= @ssl_certificate %>;
    ssl_certificate_key <%= @ssl_certificate %>;
    <% end %>

    location @gitweb_server {
        proxy_set_header Host $http_host;
        proxy_pass http://gitweb_server;
    }

    location / {
        try_files $uri @gitweb_server;
    }
}

<% if @ssl_certificate and @http_to_https %>
server {
    charset utf8;
    server_tokens off;

    server_name <%= @server_name %>;
    access_log off;

    rewrite ^ https://$server_name$request_uri? permanent;
}
<% end %>
